# mule-deployments/.github/workflows/ci-build.yml

name: Reusable Mule CI Workflow

on:
  workflow_call:
    secrets:
      CA_CLIENT_ID:
        required: true
      CA_CLIENT_SECRET:
        required: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      CA_CLIENT_ID: ${{ secrets.CA_CLIENT_ID }}
      CA_CLIENT_SECRET: ${{ secrets.CA_CLIENT_SECRET }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Build and Run Unit Tests with Output
        run: |
          echo "🔨 Starting Maven build and MUnit test execution..."
          mvn clean package \
            --batch-mode \
            -Dstyle.color=always \
            -Dmaven.test.skip=false \
            -s .maven/settings.xml

          echo "✅ Build and test completed."
          echo "📄 Test reports available in: target/surefire-reports/"
          echo "📦 Artifacts generated in: target/*.jar"

      - name: Rename JAR with Commit Hash
        run: |
          echo "🔍 Finding JAR file in target directory..."
          artifact=$(ls target/*.jar | head -1)
          echo "📦 Found artifact: $artifact"

          hash=$(git rev-parse --short "$GITHUB_SHA")
          renamed="target/$(basename "$artifact" .jar)-$hash.jar"

          echo "✏️ Renaming artifact to: $renamed"
          mv "$artifact" "$renamed"

          echo "✅ JAR file renamed and ready for upload."
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mule-artifact
          path: target/*.jar
          retention-days: 30

      - name: Upload JUnit XML Reports
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: target/surefire-reports/*.xml
          retention-days: 30

      - name: Upload MUnit Coverage Report (if available)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: munit-coverage
          path: |
            target/site/munit/coverage/index.html
            target/site/munit/coverage/clover.xml
            target/site/munit/coverage/html/index.html
          retention-days: 30
